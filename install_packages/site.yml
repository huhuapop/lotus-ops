- hosts: all
  remote_user: root
  gather_facts: false
  tasks:
    - name: "copy file to remote server"
      copy:
        src: "/home/omega/lotus-ops/install_packages/env"
        dest: "/root/.cargo"
        owner: root
        group: root
        mode: 755

- hosts: all
  tasks:
    - name: install packages
      become: true
      become_user: root
      action: >
       {{ ansible_pkg_mgr }} name=htop,transmission state=present update_cache=yes

    - name: Run update ntpdate
      shell: sudo apt install ntpdate  -y

    - name: Run update curl htop
      become: true
      become_user: root
      shell: sudo apt install curl htop  -y

    - name: Run install cmake libncurses5-dev libncursesw5-dev git -y
      shell: sudo apt install cmake libncurses5-dev libncursesw5-dev git -y

    - name: Run git clone https://github.com/Syllo/nvtop.git
      shell: cd ~  && rm -rf nvtop && git clone https://github.com/Syllo/nvtop.git

    - name: Run mkdir -p nvtop/build && cd nvtop/build && cmake .. -DNVML_RETRIEVE_HEADER_ONLINE=True  && sudo make install
      shell: mkdir -p nvtop/build && cd nvtop/build && cmake .. -DNVML_RETRIEVE_HEADER_ONLINE=True  && sudo make install

    - name: Run update
      shell: sudo apt update

    - name: Run install mesa-opencl-icd ocl-icd-opencl-dev gcc git bzr jq pkg-config curl clang build-essential hwloc libhwloc-dev wget -y && sudo apt upgrade
      shell: sudo apt install mesa-opencl-icd ocl-icd-opencl-dev gcc git bzr jq pkg-config curl clang build-essential hwloc libhwloc-dev wget -y && sudo apt upgrade -y

    - name: Run install mesa-opencl-icd ocl-icd-opencl-dev
      shell: sudo apt install mesa-opencl-icd ocl-icd-opencl-dev -y

    - name: Run add-apt-repository ppa:longsleep/golang-backports
      shell: sudo add-apt-repository ppa:longsleep/golang-backports -y

    - name: Run update
      shell: sudo apt update -y

    - name: Run install golang-go gcc git bzr jq pkg-config mesa-opencl-icd ocl-icd-opencl-dev
      shell: sudo apt install golang-go gcc git bzr jq pkg-config mesa-opencl-icd ocl-icd-opencl-dev -y

    # - name: Download rustup
    #   ansible.builtin.get_url:
    #     url: https://sh.rustup.rs
    #     dest: /root/rustup.sh
    - name: Download rustup
      get_url:
        url: https://sh.rustup.rs
        dest: /root/rustup.sh
        mode: 700

    - name: Download/Run golang
      shell: wget -c https://golang.org/dl/go1.16.4.linux-amd64.tar.gz -O - | sudo tar -xz -C /usr/local

    - name: Run update
      shell: sudo apt update -y

    # - name: Run source $HOME/.cargo/env rustup
    #   ansible.builtin.shell:
    #     cmd: source $HOME/.cargo/env && rustup

    - name: Run git clone https://github.com/filecoin-project/lotus.git
      shell: cd ~ && rm -rf lotus && git clone https://github.com/filecoin-project/lotus.git

    # - name: Run make lotus
    #   ansible.builtin.shell:
    #     cmd: cd ~/lotus/ && RUSTFLAGS="-C target-cpu=native -g" FFI_BUILD_FROM_SOURCE=1 && . $HOME/.cargo/env && make clean deps && make all

    # - name: Run install lotus
    #   ansible.builtin.shell:
    #     cmd: cd ~/lotus/ && RUSTFLAGS="-C target-cpu=native -g" FFI_BUILD_FROM_SOURCE=1 && sudo make install
    
    - name: Run clean all 
      shell: RUSTFLAGS="-C target-cpu=native -g"  FFI_BUILD_FROM_SOURCE=1  PATH=$PATH:/usr/local/go/bin && cd ~/lotus/ && make clean all 

    - name: Run make install
      shell: RUSTFLAGS="-C target-cpu=native -g"  FFI_BUILD_FROM_SOURCE=1  PATH=$PATH:/usr/local/go/bin && cd ~/lotus/ && make install
